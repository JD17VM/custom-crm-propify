name: Deploy to Hostinger
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: root
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "--- Iniciando despliegue ---"
            cd /etc/easypanel/projects/propify_crm/odoo/volumes/odoo-addons/custom_crm_propify || exit
            
            echo "1. Configurando Git Safe Directory..."
            git config --global --add safe.directory /etc/easypanel/projects/propify_crm/odoo/volumes/odoo-addons/custom_crm_propify
            
            echo "2. Sincronizando código desde GitHub..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "3. Corrigiendo permisos para Odoo (User 101)..."
            chown -R 101:101 .
            chmod -R 755 .
            
            echo "4. Buscando contenedor de Odoo activo..."
            # Esto selecciona el contenedor de odoo que lleve menos tiempo creado o esté Up
            CONTAINER_ID=$(docker ps --filter "name=propify_crm_odoo" --filter "status=running" --format "{{.Names}}" | head -n 1)
            
            if [ -z "$CONTAINER_ID" ]; then
              echo "ERROR: No se encontró ningún contenedor de Odoo corriendo."
              exit 1
            fi
            
            echo "5. Ejecutando actualización en: $CONTAINER_ID"
            docker exec -u 0 "$CONTAINER_ID" odoo -u custom_crm_propify -d propify_crm --stop-after-init
            
            echo "--- ¡Despliegue exitoso! ---"